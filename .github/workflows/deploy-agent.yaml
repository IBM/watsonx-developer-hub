name: Test and deploy the agent

on:
  push:
    branches: [main]

env:
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION }}
  AGENT_WORKDIR: ${{ vars.AGENT_WORKDIR }}

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
    steps:
    - name: Checkout latest update
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up agent
      env:
        WATSONX_API_KEY: ${{ secrets.WATSONX_API_KEY }}
        WATSONX_URL: ${{ secrets.WATSONX_URL }}
        WATSONX_SPACE_ID: ${{ secrets.WATSONX_SPACE_ID_DEV }}
      run: python scripts/setup-agent-deployment.py
    - name: Deploy agent to dev space
      id: deploy
      run: cd "${AGENT_WORKDIR}" && watsonx-ai service new | grep -o "deployment_id='[^']*'" >> "$GITHUB_OUTPUT"

  test:
    runs-on: ubuntu-latest
    needs: deploy-dev
    steps:
    - name: Checkout latest update
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - env:
        DEPLOYMENT_ID: ${{ needs.deploy-dev.outputs.deployment_id }}
      run: echo "${DEPLOYMENT_ID}"
    - name: Set up quality test
      run: python scripts/setup-agent-test.py
    - name: Test the agent
      run: cd "${AGENT_WORKDIR}" && poetry env activate && pytest -r 'fEsxX' tests/

  deploy-prod:
    runs-on: ubuntu-latest
    needs: [deploy-dev, test]
    steps:
    - name: Checkout latest update
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up agent
      env:
        WATSONX_API_KEY: ${{ secrets.WATSONX_API_KEY }}
        WATSONX_URL: ${{ secrets.WATSONX_URL }}
        WATSONX_SPACE_ID: ${{ secrets.WATSONX_SPACE_ID_PROD }}
      run: python scripts/setup-agent-deployment.py
    - name: Deploy agent to dev space
      run: cd "${AGENT_WORKDIR}" && watsonx-ai service new
